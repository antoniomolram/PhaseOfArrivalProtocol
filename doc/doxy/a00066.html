<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>MiXiM: CSMAMacLayer Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>CSMAMacLayer Class Reference<br/>
<small>
[<a class="el" href="a00444.html">macLayer - MAC layer modules</a>,&nbsp;<a class="el" href="a00460.html">CSMA - Classes for the CSMA implementation of MiXiM</a>]</small>
</h1><!-- doxytag: class="CSMAMacLayer" --><!-- doxytag: inherits="BaseMacLayer" -->
<p>MAC module which provides non-persistent CSMA.  
<a href="#_details">More...</a></p>

<p><code>#include &lt;<a class="el" href="a00334_source.html">CSMAMacLayer.h</a>&gt;</code></p>

<p>Inherits <a class="el" href="a00022.html">BaseMacLayer</a>.</p>
<div class="dynheader">
Collaboration diagram for CSMAMacLayer:</div>
<div class="dynsection">
<div class="center"><img src="a00578.png" border="0" usemap="#CSMAMacLayer_coll__map" alt="Collaboration graph"/></div>
<map name="CSMAMacLayer_coll__map" id="CSMAMacLayer_coll__map">
<area shape="rect" href="a00022.html" title="A very simple MAC module template which provides de&#45; and encapsulation of messages..." alt="" coords="9,5,119,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="a00579.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Protected Types</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913">States</a> { <a class="el" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631">RX</a>, 
<a class="el" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913acd80830b40d6cc8615ea4ff537cb37ca">CCA</a>, 
<a class="el" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913a18461bd2358689c90c3c5cade629e0b0">TX</a>
 }</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><p>MAC states. </p>
 <a href="a00066.html#aa504ef94f12cc702c82a81f5f0654913">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af397ee30d94486721632bbcdad8274d1"></a><!-- doxytag: member="CSMAMacLayer::MacQueue" ref="af397ee30d94486721632bbcdad8274d1" args="" -->
typedef std::list&lt; cPacket * &gt;&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#af397ee30d94486721632bbcdad8274d1">MacQueue</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Type for a queue of cPackets. <br/></td></tr>
<tr><td colspan="2"><h2>Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a660262c629f33b00401249d3fdac49be">initialize</a> (int)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Inspect reasons for dropped packets.  <a href="#a660262c629f33b00401249d3fdac49be"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aeaffa0655b4e87224a9a2f09b96805d7"></a><!-- doxytag: member="CSMAMacLayer::finish" ref="aeaffa0655b4e87224a9a2f09b96805d7" args="()" -->
virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#aeaffa0655b4e87224a9a2f09b96805d7">finish</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Delete all dynamically allocated objects of the module. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a83911b5673de047bcfc3c9b0a719ff15">handleLowerMsg</a> (cMessage *)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handle messages from lower layer.  <a href="#a83911b5673de047bcfc3c9b0a719ff15"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a06c96c060afdff5c0f348b5ebef5c54d">handleUpperMsg</a> (cMessage *)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handle messages from upper layer.  <a href="#a06c96c060afdff5c0f348b5ebef5c54d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a254a29c1cc1f0292039d57c1d189cda3">handleSelfMsg</a> (cMessage *)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handle self messages such as timers.  <a href="#a254a29c1cc1f0292039d57c1d189cda3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a2eb12cedf0b4b5e6fda8bd6666186cb6"></a><!-- doxytag: member="CSMAMacLayer::handleLowerControl" ref="a2eb12cedf0b4b5e6fda8bd6666186cb6" args="(cMessage *msg)" -->
virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a2eb12cedf0b4b5e6fda8bd6666186cb6">handleLowerControl</a> (cMessage *msg)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handle control messages from lower layer. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#aa4ace66cbd53164dc27f4fba70dd60b4">scheduleBackoff</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">schedule a backoff  <a href="#aa4ace66cbd53164dc27f4fba70dd60b4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a12641a9e99a3064797647cf3b4946824"></a><!-- doxytag: member="CSMAMacLayer::encapsMsg" ref="a12641a9e99a3064797647cf3b4946824" args="(cPacket *pkt)" -->
virtual MacPkt *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a12641a9e99a3064797647cf3b4946824">encapsMsg</a> (cPacket *pkt)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Encapsulates the NetwPkt into the MacPkt and sets the parameters. <br/></td></tr>
<tr><td colspan="2"><h2>Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aa78817d8e3bbf7850e5d84a6377ea907"></a><!-- doxytag: member="CSMAMacLayer::macState" ref="aa78817d8e3bbf7850e5d84a6377ea907" args="" -->
<a class="el" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913">States</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907">macState</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">kepp track of MAC state <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a420bec99b62f029c75996930bc5cb56f">slotDuration</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Duration of a slot.  <a href="#a420bec99b62f029c75996930bc5cb56f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a5a0fde63ac12cccfdb98bfe6314ce46d">difs</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Maximum time between a packet and its ACK.  <a href="#a5a0fde63ac12cccfdb98bfe6314ce46d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a9869bd7667eacdb3a9c5f8ecb0c3ed19"></a><!-- doxytag: member="CSMAMacLayer::macQueue" ref="a9869bd7667eacdb3a9c5f8ecb0c3ed19" args="" -->
<a class="el" href="a00066.html#af397ee30d94486721632bbcdad8274d1">MacQueue</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a9869bd7667eacdb3a9c5f8ecb0c3ed19">macQueue</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">A queue to store packets from upper layer in case another packet is still waiting for transmission.. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a27628021750dc0e8cf651382663276b8"></a><!-- doxytag: member="CSMAMacLayer::queueLength" ref="a27628021750dc0e8cf651382663276b8" args="" -->
unsigned&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a27628021750dc0e8cf651382663276b8">queueLength</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">length of the queue <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a946e29bb8fead33566797a7062649a1e"></a><!-- doxytag: member="CSMAMacLayer::backoffTimer" ref="a946e29bb8fead33566797a7062649a1e" args="" -->
cMessage *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a946e29bb8fead33566797a7062649a1e">backoffTimer</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Timer for backoff (non-persistent CSMA). <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">cMessage *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#af06855c96a26dbe77937062bead7f82c">minorMsg</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Multi-purpose message.  <a href="#af06855c96a26dbe77937062bead7f82c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">unsigned&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a6c9b1b0f5eeb45db611633ca986f537b">txAttempts</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">count the number of tx attempts  <a href="#a6c9b1b0f5eeb45db611633ca986f537b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">unsigned&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#ae3aa6dae3903cabacbcafe783ef33d91">maxTxAttempts</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">maximum number of transmission attempts  <a href="#ae3aa6dae3903cabacbcafe783ef33d91"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a70ae938b76fa8fe65d97b0b511767894"></a><!-- doxytag: member="CSMAMacLayer::bitrate" ref="a70ae938b76fa8fe65d97b0b511767894" args="" -->
double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a70ae938b76fa8fe65d97b0b511767894">bitrate</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">the bit rate at which we transmit <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a619cc05568e8ebef57ff9c551cd311d0"></a><!-- doxytag: member="CSMAMacLayer::txPower" ref="a619cc05568e8ebef57ff9c551cd311d0" args="" -->
double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a619cc05568e8ebef57ff9c551cd311d0">txPower</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The power at which we transmit. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8ec2aea0983e2149d3c7d1c06637dd70"></a><!-- doxytag: member="CSMAMacLayer::initialCW" ref="a8ec2aea0983e2149d3c7d1c06637dd70" args="" -->
unsigned&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a8ec2aea0983e2149d3c7d1c06637dd70">initialCW</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">initial contention window size <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae768a2dadff7e2e41a5ecae37bcedc2d"></a><!-- doxytag: member="CSMAMacLayer::nbBackoffs" ref="ae768a2dadff7e2e41a5ecae37bcedc2d" args="" -->
double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#ae768a2dadff7e2e41a5ecae37bcedc2d">nbBackoffs</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Counts the total number of backoffs. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ace6a061501b4d12d2380a458ea253ef5"></a><!-- doxytag: member="CSMAMacLayer::backoffValues" ref="ace6a061501b4d12d2380a458ea253ef5" args="" -->
double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#ace6a061501b4d12d2380a458ea253ef5">backoffValues</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Counts the total time spent in backoff. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a4e15b3f78a53218321cbc408f1cb600b"></a><!-- doxytag: member="CSMAMacLayer::nbTxFrames" ref="a4e15b3f78a53218321cbc408f1cb600b" args="" -->
unsigned long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a4e15b3f78a53218321cbc408f1cb600b">nbTxFrames</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Counts the number of frames transmitted. <br/></td></tr>
<tr><td colspan="2"><h2>Private Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a00a8c8316ff1b37292d80b7ae4e3cb1c"></a><!-- doxytag: member="CSMAMacLayer::CSMAMacLayer" ref="a00a8c8316ff1b37292d80b7ae4e3cb1c" args="(const CSMAMacLayer &amp;)" -->
&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a00a8c8316ff1b37292d80b7ae4e3cb1c">CSMAMacLayer</a> (const <a class="el" href="a00066.html">CSMAMacLayer</a> &amp;)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Copy constructor is not allowed. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a5e45c114db302a9337ea13ca378cd98a"></a><!-- doxytag: member="CSMAMacLayer::operator=" ref="a5e45c114db302a9337ea13ca378cd98a" args="(const CSMAMacLayer &amp;)" -->
<a class="el" href="a00066.html">CSMAMacLayer</a> &amp;&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00066.html#a5e45c114db302a9337ea13ca378cd98a">operator=</a> (const <a class="el" href="a00066.html">CSMAMacLayer</a> &amp;)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Assignment operator is not allowed. <br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>MAC module which provides non-persistent CSMA. </p>
<p>This is an implementation of a simple non-persistent CSMA. The idea of nonpersistent CSMA is "listen before talk". Before attempting to transmit, a station will sense the medium for a carrier signal, which, if present, indicates that some other station is sending.</p>
<p>If the channel is busy a random waiting time is computed and after this time the channel is sensed again. Once the channel gets idle the message is sent. (State of the channel is obtained from <a class="el" href="a00042.html" title="This class is used by the BasePhyLayer to keep track of the AirFrames on the channel...">ChannelInfo</a> via phyLayer.)</p>
<p>An option of this module is to use a queue. If a packet from the upper layer arrives although there is still another packet waiting for its transmission or being transmitted the new packet can be stored in this queue. The length of this queue can be specified by the user in the omnetpp.ini file. By default the length is 0. If the queue is full or there is no queue (length = 0) new packet(s) will be deleted.</p>
<p>ATTENTION: Imagine the following scenario:</p>
<p>Several stations receive a broadcast request packet, usally exactly at the same time. They will all try to answer at exactly the same time, i.e. they all will sense the channel at exactly the same time and start to transmit because the channel was sensed idle by all of them. Therefore a small random delay should be built into one/some of the upper layers to simulate a random processing time!</p>
<p>The <a class="el" href="a00184.html" title="Test class for the application layer.">TestApplLayer</a> e.g. implements such a processing delay!</p>
<dl class="author"><dt><b>Author:</b></dt><dd>Marc Lï¿½bbers, Yosia Hadisusanto, Andreas Koepke, Karl Wessel </dd></dl>

<p>Definition at line <a class="el" href="a00334_source.html#l00048">48</a> of file <a class="el" href="a00334_source.html">CSMAMacLayer.h</a>.</p>
<hr/><h2>Member Enumeration Documentation</h2>
<a class="anchor" id="aa504ef94f12cc702c82a81f5f0654913"></a><!-- doxytag: member="CSMAMacLayer::States" ref="aa504ef94f12cc702c82a81f5f0654913" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913">CSMAMacLayer::States</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>MAC states. </p>
<p>The MAC states help to keep track what the MAC is actually trying to do -- this is esp. useful when radio switching takes some time. </p>
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631"></a><!-- doxytag: member="RX" ref="aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631" args="" -->RX</em>&nbsp;</td><td>
<p>MAC accepts packets from PHY layer. </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aa504ef94f12cc702c82a81f5f0654913acd80830b40d6cc8615ea4ff537cb37ca"></a><!-- doxytag: member="CCA" ref="aa504ef94f12cc702c82a81f5f0654913acd80830b40d6cc8615ea4ff537cb37ca" args="" -->CCA</em>&nbsp;</td><td>
<p>Clear Channel Assessment - MAC checks whether medium is busy. </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aa504ef94f12cc702c82a81f5f0654913a18461bd2358689c90c3c5cade629e0b0"></a><!-- doxytag: member="TX" ref="aa504ef94f12cc702c82a81f5f0654913a18461bd2358689c90c3c5cade629e0b0" args="" -->TX</em>&nbsp;</td><td>
<p>MAC transmits a packet. </p>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="a00334_source.html#l00089">89</a> of file <a class="el" href="a00334_source.html">CSMAMacLayer.h</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00089"></a>00089                 {
<a name="l00091"></a>00091         <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631" title="MAC accepts packets from PHY layer.">RX</a>,
<a name="l00093"></a>00093         <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913acd80830b40d6cc8615ea4ff537cb37ca" title="Clear Channel Assessment - MAC checks whether medium is busy.">CCA</a>,
<a name="l00095"></a>00095         <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913a18461bd2358689c90c3c5cade629e0b0" title="MAC transmits a packet.">TX</a>,
<a name="l00096"></a>00096     };
</pre></div></p>

</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a83911b5673de047bcfc3c9b0a719ff15"></a><!-- doxytag: member="CSMAMacLayer::handleLowerMsg" ref="a83911b5673de047bcfc3c9b0a719ff15" args="(cMessage *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CSMAMacLayer::handleLowerMsg </td>
          <td>(</td>
          <td class="paramtype">cMessage *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Handle messages from lower layer. </p>
<p>Compare the address of this Host with the destination address in frame. If they are equal or the frame is broadcast, we send this frame to the upper layer. If not delete it. </p>

<p>Reimplemented from <a class="el" href="a00022.html#a413375cec02b990a521b62086a02264c">BaseMacLayer</a>.</p>

<p>Definition at line <a class="el" href="a00333_source.html#l00204">204</a> of file <a class="el" href="a00333_source.html">CSMAMacLayer.cc</a>.</p>

<p>References <a class="el" href="a00334_source.html#l00125">backoffTimer</a>, <a class="el" href="a00242_source.html#l00129">BaseMacLayer::decapsMsg()</a>, <a class="el" href="a00295_source.html#l00074">LAddress::isL2Broadcast()</a>, <a class="el" href="a00243_source.html#l00081">BaseMacLayer::myMacAddr</a>, <a class="el" href="a00333_source.html#l00245">scheduleBackoff()</a>, and <a class="el" href="a00240_source.html#l00115">BaseLayer::sendUp()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00205"></a>00205 {
<a name="l00206"></a>00206     MacPkt*                 mac  = <span class="keyword">static_cast&lt;</span>MacPkt *<span class="keyword">&gt;</span>(msg);
<a name="l00207"></a>00207     <span class="keyword">const</span> <a class="code" href="a00105.html#aea56b60dcb5ae8c2bde465271daf7210" title="Type definition for a L2 (MAC) address.">LAddress::L2Type</a>&amp; dest = mac-&gt;getDestAddr();
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">if</span>(dest == <a class="code" href="a00022.html#a8a26df9da07801d8ccb530530ef57ee2" title="MAC address.">myMacAddr</a> || <a class="code" href="a00105.html#a3890f1c7314c5695e32252468e6bd5a5" title="Test if a L2 address (pSrcAddr) is a broadcast address.">LAddress::isL2Broadcast</a>(dest))
<a name="l00210"></a>00210     {
<a name="l00211"></a>00211       debugEV &lt;&lt; <span class="stringliteral">&quot;sending pkt to upper...\n&quot;</span>;
<a name="l00212"></a>00212         <a class="code" href="a00021.html#adbf061566606041db811b519f0400ed5" title="Sends a message to the upper layer.">sendUp</a>(<a class="code" href="a00022.html#ab5c40c53eda6e5a5041bddebfab6e0b6" title="decapsulate the network message from the MacPkt">decapsMsg</a>(mac));
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214     <span class="keywordflow">else</span> {
<a name="l00215"></a>00215       debugEV &lt;&lt; <span class="stringliteral">&quot;packet not for me, deleting...\n&quot;</span>;
<a name="l00216"></a>00216         <span class="keyword">delete</span> mac;
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     <span class="keywordflow">if</span>(!<a class="code" href="a00066.html#a946e29bb8fead33566797a7062649a1e" title="Timer for backoff (non-persistent CSMA).">backoffTimer</a>-&gt;isScheduled()) <a class="code" href="a00066.html#aa4ace66cbd53164dc27f4fba70dd60b4" title="schedule a backoff">scheduleBackoff</a>();
<a name="l00220"></a>00220 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a254a29c1cc1f0292039d57c1d189cda3"></a><!-- doxytag: member="CSMAMacLayer::handleSelfMsg" ref="a254a29c1cc1f0292039d57c1d189cda3" args="(cMessage *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CSMAMacLayer::handleSelfMsg </td>
          <td>(</td>
          <td class="paramtype">cMessage *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Handle self messages such as timers. </p>
<p>After the timer expires try to retransmit the message by calling handleUpperMsg again. </p>

<p>Reimplemented from <a class="el" href="a00022.html#add5277c1a60dab10db40c8d9641e48c4">BaseMacLayer</a>.</p>

<p>Definition at line <a class="el" href="a00333_source.html#l00142">142</a> of file <a class="el" href="a00333_source.html">CSMAMacLayer.cc</a>.</p>

<p>References <a class="el" href="a00334_source.html#l00125">backoffTimer</a>, <a class="el" href="a00334_source.html#l00093">CCA</a>, <a class="el" href="a00334_source.html#l00115">difs</a>, <a class="el" href="a00119.html#affa30a25b96ffe387b22c68ca35f77a5">MacToPhyInterface::getChannelState()</a>, <a class="el" href="a00119.html#a00dd43576b4da205117d53bd3baadc71">MacToPhyInterface::getRadioState()</a>, <a class="el" href="a00263_source.html#l00003">ChannelState::isIdle()</a>, <a class="el" href="a00334_source.html#l00119">macQueue</a>, <a class="el" href="a00334_source.html#l00099">macState</a>, <a class="el" href="a00334_source.html#l00132">minorMsg</a>, <a class="el" href="a00243_source.html#l00068">BaseMacLayer::phy</a>, <a class="el" href="a00278_source.html#l00206">Radio::RX</a>, <a class="el" href="a00334_source.html#l00091">RX</a>, <a class="el" href="a00333_source.html#l00245">scheduleBackoff()</a>, <a class="el" href="a00119.html#ad25abbad9aa16bdbf24bf1dd582b1c6f">MacToPhyInterface::setRadioState()</a>, <a class="el" href="a00278_source.html#l00208">Radio::TX</a>, and <a class="el" href="a00334_source.html#l00095">TX</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00143"></a>00143 {
<a name="l00144"></a>00144     <span class="keywordflow">if</span>(msg == <a class="code" href="a00066.html#a946e29bb8fead33566797a7062649a1e" title="Timer for backoff (non-persistent CSMA).">backoffTimer</a>) {
<a name="l00145"></a>00145       debugEV &lt;&lt; <span class="stringliteral">&quot;backoffTimer &quot;</span>;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         <span class="keywordflow">if</span>(<a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a> == <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631" title="MAC accepts packets from PHY layer.">RX</a>) {
<a name="l00148"></a>00148           debugEV &lt;&lt; <span class="stringliteral">&quot; RX &quot;</span>;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150             <span class="keywordflow">if</span>(<a class="code" href="a00066.html#a9869bd7667eacdb3a9c5f8ecb0c3ed19" title="A queue to store packets from upper layer in case another packet is still waiting...">macQueue</a>.size() != 0) {
<a name="l00151"></a>00151               <a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a> = <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913acd80830b40d6cc8615ea4ff537cb37ca" title="Clear Channel Assessment - MAC checks whether medium is busy.">CCA</a>;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153                 <span class="keywordflow">if</span>(<a class="code" href="a00022.html#aa7b1e6bdb734765a9f4eff7d486dfbea" title="Handler to the physical layer.">phy</a>-&gt;<a class="code" href="a00119.html#a00dd43576b4da205117d53bd3baadc71" title="Returns the current state the radio is in. See RadioState for possible values.">getRadioState</a>() == <a class="code" href="a00158.html#a7314de88eaecfa054e682ccc84ef0ffaa0a9f9ba2fd83cf0f5f4eaf4f32d6a9c1" title="receiving state">Radio::RX</a>) {
<a name="l00154"></a>00154 
<a name="l00155"></a>00155                     <span class="keywordflow">if</span>(<a class="code" href="a00022.html#aa7b1e6bdb734765a9f4eff7d486dfbea" title="Handler to the physical layer.">phy</a>-&gt;<a class="code" href="a00119.html#affa30a25b96ffe387b22c68ca35f77a5" title="Returns the current state of the channel. See ChannelState for details.">getChannelState</a>().<a class="code" href="a00043.html#ab09e4515d5428b1287a62ec1bd1b01fe" title="Returns true if the channel is considered idle, meaning depends on the used decider...">isIdle</a>()) {
<a name="l00156"></a>00156                       debugEV &lt;&lt; <span class="stringliteral">&quot; idle &quot;</span>;
<a name="l00157"></a>00157                         scheduleAt(simTime()+<a class="code" href="a00066.html#a5a0fde63ac12cccfdb98bfe6314ce46d" title="Maximum time between a packet and its ACK.">difs</a>, <a class="code" href="a00066.html#af06855c96a26dbe77937062bead7f82c" title="Multi-purpose message.">minorMsg</a>);
<a name="l00158"></a>00158                     }
<a name="l00159"></a>00159                     <span class="keywordflow">else</span>{
<a name="l00160"></a>00160                       <a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a> = <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631" title="MAC accepts packets from PHY layer.">RX</a>;
<a name="l00161"></a>00161                       debugEV &lt;&lt; <span class="stringliteral">&quot; busy &quot;</span>;
<a name="l00162"></a>00162                         <a class="code" href="a00066.html#aa4ace66cbd53164dc27f4fba70dd60b4" title="schedule a backoff">scheduleBackoff</a>();
<a name="l00163"></a>00163                     }
<a name="l00164"></a>00164                 }
<a name="l00165"></a>00165             }
<a name="l00166"></a>00166         }
<a name="l00167"></a>00167         <span class="keywordflow">else</span> {
<a name="l00168"></a>00168           debugEV &lt;&lt; <span class="stringliteral">&quot;&quot;</span> &lt;&lt; endl;
<a name="l00169"></a>00169           debugEV &lt;&lt; <span class="stringliteral">&quot;state=&quot;</span> &lt;&lt; <a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a> &lt;&lt; <span class="stringliteral">&quot;(TX=&quot;</span>&lt;&lt;<a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913a18461bd2358689c90c3c5cade629e0b0" title="MAC transmits a packet.">TX</a>&lt;&lt;<span class="stringliteral">&quot;, CCA=&quot;</span>&lt;&lt;<a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913acd80830b40d6cc8615ea4ff537cb37ca" title="Clear Channel Assessment - MAC checks whether medium is busy.">CCA</a>&lt;&lt;<span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l00170"></a>00170             error(<span class="stringliteral">&quot;backoffTimer expired, MAC in wrong state&quot;</span>);
<a name="l00171"></a>00171         }
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(msg == <a class="code" href="a00066.html#af06855c96a26dbe77937062bead7f82c" title="Multi-purpose message.">minorMsg</a>) {
<a name="l00174"></a>00174       debugEV &lt;&lt; <span class="stringliteral">&quot; minorMsg &quot;</span>;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <span class="comment">//TODO: replace with channel sense request</span>
<a name="l00177"></a>00177         <span class="keywordflow">if</span>((<a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a> == <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913acd80830b40d6cc8615ea4ff537cb37ca" title="Clear Channel Assessment - MAC checks whether medium is busy.">CCA</a>) &amp;&amp; (<a class="code" href="a00022.html#aa7b1e6bdb734765a9f4eff7d486dfbea" title="Handler to the physical layer.">phy</a>-&gt;<a class="code" href="a00119.html#a00dd43576b4da205117d53bd3baadc71" title="Returns the current state the radio is in. See RadioState for possible values.">getRadioState</a>() == <a class="code" href="a00158.html#a7314de88eaecfa054e682ccc84ef0ffaa0a9f9ba2fd83cf0f5f4eaf4f32d6a9c1" title="receiving state">Radio::RX</a>)) {
<a name="l00178"></a>00178 
<a name="l00179"></a>00179             <span class="keywordflow">if</span>(<a class="code" href="a00022.html#aa7b1e6bdb734765a9f4eff7d486dfbea" title="Handler to the physical layer.">phy</a>-&gt;<a class="code" href="a00119.html#affa30a25b96ffe387b22c68ca35f77a5" title="Returns the current state of the channel. See ChannelState for details.">getChannelState</a>().<a class="code" href="a00043.html#ab09e4515d5428b1287a62ec1bd1b01fe" title="Returns true if the channel is considered idle, meaning depends on the used decider...">isIdle</a>()) {
<a name="l00180"></a>00180               debugEV &lt;&lt; <span class="stringliteral">&quot; idle -&gt; to send &quot;</span>;
<a name="l00181"></a>00181                 <a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a> = <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913a18461bd2358689c90c3c5cade629e0b0" title="MAC transmits a packet.">TX</a>;
<a name="l00182"></a>00182                 <a class="code" href="a00022.html#aa7b1e6bdb734765a9f4eff7d486dfbea" title="Handler to the physical layer.">phy</a>-&gt;<a class="code" href="a00119.html#ad25abbad9aa16bdbf24bf1dd582b1c6f" title="Tells the BasePhyLayer to switch to the specified radio state.">setRadioState</a>(<a class="code" href="a00158.html#a7314de88eaecfa054e682ccc84ef0ffaa55eab2480eb0876c6b76dc0df92882f7" title="transmitting state">Radio::TX</a>);
<a name="l00183"></a>00183             }
<a name="l00184"></a>00184             <span class="keywordflow">else</span> {
<a name="l00185"></a>00185               debugEV &lt;&lt; <span class="stringliteral">&quot; busy -&gt; backoff &quot;</span>;
<a name="l00186"></a>00186                 <a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a> = <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631" title="MAC accepts packets from PHY layer.">RX</a>;
<a name="l00187"></a>00187                 <span class="keywordflow">if</span>(!<a class="code" href="a00066.html#a946e29bb8fead33566797a7062649a1e" title="Timer for backoff (non-persistent CSMA).">backoffTimer</a>-&gt;isScheduled())
<a name="l00188"></a>00188                   <a class="code" href="a00066.html#aa4ace66cbd53164dc27f4fba70dd60b4" title="schedule a backoff">scheduleBackoff</a>();
<a name="l00189"></a>00189             }
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191         <span class="keywordflow">else</span> {
<a name="l00192"></a>00192             error(<span class="stringliteral">&quot;minClearTimer fired -- channel or mac in wrong state&quot;</span>);
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195     debugEV &lt;&lt; endl;
<a name="l00196"></a>00196 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a06c96c060afdff5c0f348b5ebef5c54d"></a><!-- doxytag: member="CSMAMacLayer::handleUpperMsg" ref="a06c96c060afdff5c0f348b5ebef5c54d" args="(cMessage *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CSMAMacLayer::handleUpperMsg </td>
          <td>(</td>
          <td class="paramtype">cMessage *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Handle messages from upper layer. </p>
<p>First it has to be checked whether a frame is currently being transmitted or waiting to be transmitted. If so the newly arrived message is stored in a queue. If there is no queue or it is full print a warning.</p>
<p>Before transmitting a frame it is tested whether the channel is busy at the moment or not. If the channel is busy, a short random time will be generated and the MacPkt is buffered for this time, before a next attempt to send the packet is started.</p>
<p>If channel is idle the frame will be transmitted immediately. </p>

<p>Reimplemented from <a class="el" href="a00022.html#a6de2ca07018de313a7147a03e6d77bff">BaseMacLayer</a>.</p>

<p>Definition at line <a class="el" href="a00333_source.html#l00105">105</a> of file <a class="el" href="a00333_source.html">CSMAMacLayer.cc</a>.</p>

<p>References <a class="el" href="a00334_source.html#l00125">backoffTimer</a>, <a class="el" href="a00333_source.html#l00289">encapsMsg()</a>, <a class="el" href="a00334_source.html#l00119">macQueue</a>, <a class="el" href="a00334_source.html#l00099">macState</a>, <a class="el" href="a00243_source.html#l00059">BaseMacLayer::PACKET_DROPPED</a>, <a class="el" href="a00334_source.html#l00122">queueLength</a>, <a class="el" href="a00334_source.html#l00091">RX</a>, <a class="el" href="a00333_source.html#l00245">scheduleBackoff()</a>, and <a class="el" href="a00240_source.html#l00120">BaseLayer::sendControlUp()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00106"></a>00106 {
<a name="l00107"></a>00107   cPacket* pkt = <span class="keyword">static_cast&lt;</span>cPacket*<span class="keyword">&gt;</span>(msg);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <span class="comment">//MacPkt *mac = encapsMsg(pkt);</span>
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="comment">// message has to be queued if another message is waiting to be send</span>
<a name="l00112"></a>00112     <span class="comment">// or if we are already trying to send another message</span>
<a name="l00113"></a>00113 
<a name="l00114"></a>00114     <span class="keywordflow">if</span> (<a class="code" href="a00066.html#a9869bd7667eacdb3a9c5f8ecb0c3ed19" title="A queue to store packets from upper layer in case another packet is still waiting...">macQueue</a>.size() &lt;= <a class="code" href="a00066.html#a27628021750dc0e8cf651382663276b8" title="length of the queue">queueLength</a>)
<a name="l00115"></a>00115     {
<a name="l00116"></a>00116         <a class="code" href="a00066.html#a9869bd7667eacdb3a9c5f8ecb0c3ed19" title="A queue to store packets from upper layer in case another packet is still waiting...">macQueue</a>.push_back(pkt);
<a name="l00117"></a>00117         debugEV   &lt;&lt; <span class="stringliteral">&quot;packet putt in queue\n  queue size:&quot;</span> &lt;&lt; <a class="code" href="a00066.html#a9869bd7667eacdb3a9c5f8ecb0c3ed19" title="A queue to store packets from upper layer in case another packet is still waiting...">macQueue</a>.size() &lt;&lt; <span class="stringliteral">&quot; macState:&quot;</span> &lt;&lt; <a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a>
<a name="l00118"></a>00118       &lt;&lt; <span class="stringliteral">&quot; (RX=&quot;</span> &lt;&lt; <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631" title="MAC accepts packets from PHY layer.">RX</a> &lt;&lt; <span class="stringliteral">&quot;) is scheduled:&quot;</span> &lt;&lt; <a class="code" href="a00066.html#a946e29bb8fead33566797a7062649a1e" title="Timer for backoff (non-persistent CSMA).">backoffTimer</a>-&gt;isScheduled() &lt;&lt; endl;;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120         <span class="keywordflow">if</span>((<a class="code" href="a00066.html#a9869bd7667eacdb3a9c5f8ecb0c3ed19" title="A queue to store packets from upper layer in case another packet is still waiting...">macQueue</a>.size() == 1) &amp;&amp; (<a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a> == <a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631" title="MAC accepts packets from PHY layer.">RX</a>) &amp;&amp; !<a class="code" href="a00066.html#a946e29bb8fead33566797a7062649a1e" title="Timer for backoff (non-persistent CSMA).">backoffTimer</a>-&gt;isScheduled()) {
<a name="l00121"></a>00121             <a class="code" href="a00066.html#aa4ace66cbd53164dc27f4fba70dd60b4" title="schedule a backoff">scheduleBackoff</a>();
<a name="l00122"></a>00122         }
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124     <span class="keywordflow">else</span> {
<a name="l00125"></a>00125         <span class="comment">// queue is full, message has to be deleted</span>
<a name="l00126"></a>00126       EV &lt;&lt; <span class="stringliteral">&quot;New packet arrived, but queue is FULL, so new packet is deleted\n&quot;</span>;
<a name="l00127"></a>00127         MacPkt* mac = <a class="code" href="a00066.html#a12641a9e99a3064797647cf3b4946824" title="Encapsulates the NetwPkt into the MacPkt and sets the parameters.">encapsMsg</a>(pkt);
<a name="l00128"></a>00128         mac-&gt;setName(<span class="stringliteral">&quot;MAC ERROR&quot;</span>);
<a name="l00129"></a>00129         mac-&gt;setKind(<a class="code" href="a00022.html#a49e0e548a6c20d002bd67afa7b76c483adebf9c77bbe6f19772866cccbef0fe4b">PACKET_DROPPED</a>);
<a name="l00130"></a>00130         <a class="code" href="a00021.html#aa1190a06fb4dfb15d8ff001468335dc8" title="Sends a control message to an upper layer.">sendControlUp</a>(mac);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132         <span class="comment">//TODO: send packet drop bb info</span>
<a name="l00133"></a>00133         <span class="comment">//droppedPacket.setReason(DroppedPacket::QUEUE);</span>
<a name="l00134"></a>00134         <span class="comment">//emitItem(catDroppedPacket, &amp;droppedPacket);</span>
<a name="l00135"></a>00135     }
<a name="l00136"></a>00136 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a660262c629f33b00401249d3fdac49be"></a><!-- doxytag: member="CSMAMacLayer::initialize" ref="a660262c629f33b00401249d3fdac49be" args="(int)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">virtual void CSMAMacLayer::initialize </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Inspect reasons for dropped packets. </p>
<p>plus category from BB publish dropped packets nic wide Initialization of the module and some variables </p>

<p>Reimplemented from <a class="el" href="a00022.html#a61c82dc3b225eac37f7fa9936c28c2c3">BaseMacLayer</a>.</p>

</div>
</div>
<a class="anchor" id="aa4ace66cbd53164dc27f4fba70dd60b4"></a><!-- doxytag: member="CSMAMacLayer::scheduleBackoff" ref="aa4ace66cbd53164dc27f4fba70dd60b4" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CSMAMacLayer::scheduleBackoff </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>schedule a backoff </p>
<p>A non-persistent CSMA ideally uses a fixed backoff window, but it could also increase this window in a linear fashion, or even exponential -- here, a linear increase is used. Overwrite this function to define another schedule function. It also checks the retransmission counters -- if you overwrite it, do it with care. </p>

<p>Definition at line <a class="el" href="a00333_source.html#l00245">245</a> of file <a class="el" href="a00333_source.html">CSMAMacLayer.cc</a>.</p>

<p>References <a class="el" href="a00334_source.html#l00125">backoffTimer</a>, <a class="el" href="a00334_source.html#l00161">backoffValues</a>, <a class="el" href="a00333_source.html#l00289">encapsMsg()</a>, <a class="el" href="a00119.html#a00dd43576b4da205117d53bd3baadc71">MacToPhyInterface::getRadioState()</a>, <a class="el" href="a00334_source.html#l00155">initialCW</a>, <a class="el" href="a00334_source.html#l00119">macQueue</a>, <a class="el" href="a00334_source.html#l00099">macState</a>, <a class="el" href="a00334_source.html#l00146">maxTxAttempts</a>, <a class="el" href="a00334_source.html#l00132">minorMsg</a>, <a class="el" href="a00334_source.html#l00158">nbBackoffs</a>, <a class="el" href="a00243_source.html#l00059">BaseMacLayer::PACKET_DROPPED</a>, <a class="el" href="a00243_source.html#l00068">BaseMacLayer::phy</a>, <a class="el" href="a00334_source.html#l00091">RX</a>, <a class="el" href="a00240_source.html#l00120">BaseLayer::sendControlUp()</a>, <a class="el" href="a00334_source.html#l00108">slotDuration</a>, and <a class="el" href="a00334_source.html#l00140">txAttempts</a>.</p>

<p>Referenced by <a class="el" href="a00333_source.html#l00222">handleLowerControl()</a>, <a class="el" href="a00333_source.html#l00204">handleLowerMsg()</a>, <a class="el" href="a00333_source.html#l00142">handleSelfMsg()</a>, and <a class="el" href="a00333_source.html#l00105">handleUpperMsg()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00246"></a>00246 {
<a name="l00247"></a>00247     <span class="keywordflow">if</span>(<a class="code" href="a00066.html#a946e29bb8fead33566797a7062649a1e" title="Timer for backoff (non-persistent CSMA).">backoffTimer</a>-&gt;isScheduled()) {
<a name="l00248"></a>00248         std::cerr &lt;&lt; <span class="stringliteral">&quot; is scheduled: MAC state &quot;</span>
<a name="l00249"></a>00249                   &lt;&lt; <a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a> &lt;&lt; <span class="stringliteral">&quot; radio state : &quot;</span> &lt;&lt; <a class="code" href="a00022.html#aa7b1e6bdb734765a9f4eff7d486dfbea" title="Handler to the physical layer.">phy</a>-&gt;<a class="code" href="a00119.html#a00dd43576b4da205117d53bd3baadc71" title="Returns the current state the radio is in. See RadioState for possible values.">getRadioState</a>() &lt;&lt; endl;
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="keywordflow">if</span>(<a class="code" href="a00066.html#af06855c96a26dbe77937062bead7f82c" title="Multi-purpose message.">minorMsg</a>-&gt;isScheduled()){
<a name="l00253"></a>00253     cancelEvent( <a class="code" href="a00066.html#af06855c96a26dbe77937062bead7f82c" title="Multi-purpose message.">minorMsg</a> );
<a name="l00254"></a>00254     <a class="code" href="a00066.html#aa78817d8e3bbf7850e5d84a6377ea907" title="kepp track of MAC state">macState</a>=<a class="code" href="a00066.html#aa504ef94f12cc702c82a81f5f0654913ab8f2c7ef825f0c569512139f5482e631" title="MAC accepts packets from PHY layer.">RX</a>;
<a name="l00255"></a>00255   }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="keywordflow">if</span>(<a class="code" href="a00066.html#a6c9b1b0f5eeb45db611633ca986f537b" title="count the number of tx attempts">txAttempts</a> &gt; <a class="code" href="a00066.html#ae3aa6dae3903cabacbcafe783ef33d91" title="maximum number of transmission attempts">maxTxAttempts</a>) {
<a name="l00258"></a>00258       debugEV &lt;&lt; <span class="stringliteral">&quot; drop packet &quot;</span> &lt;&lt; endl;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         cMessage *mac = <a class="code" href="a00066.html#a12641a9e99a3064797647cf3b4946824" title="Encapsulates the NetwPkt into the MacPkt and sets the parameters.">encapsMsg</a>(<a class="code" href="a00066.html#a9869bd7667eacdb3a9c5f8ecb0c3ed19" title="A queue to store packets from upper layer in case another packet is still waiting...">macQueue</a>.front());
<a name="l00261"></a>00261         mac-&gt;setName(<span class="stringliteral">&quot;MAC ERROR&quot;</span>);
<a name="l00262"></a>00262         mac-&gt;setKind(<a class="code" href="a00022.html#a49e0e548a6c20d002bd67afa7b76c483adebf9c77bbe6f19772866cccbef0fe4b">PACKET_DROPPED</a>);
<a name="l00263"></a>00263         <a class="code" href="a00066.html#a6c9b1b0f5eeb45db611633ca986f537b" title="count the number of tx attempts">txAttempts</a> = 0;
<a name="l00264"></a>00264         <a class="code" href="a00066.html#a9869bd7667eacdb3a9c5f8ecb0c3ed19" title="A queue to store packets from upper layer in case another packet is still waiting...">macQueue</a>.pop_front();
<a name="l00265"></a>00265         <a class="code" href="a00021.html#aa1190a06fb4dfb15d8ff001468335dc8" title="Sends a control message to an upper layer.">sendControlUp</a>(mac);
<a name="l00266"></a>00266 
<a name="l00267"></a>00267         <span class="comment">//TODO: send packet drop bb info</span>
<a name="l00268"></a>00268         <span class="comment">//droppedPacket.setReason(DroppedPacket::CHANNEL);</span>
<a name="l00269"></a>00269         <span class="comment">//emit(catDroppedPacket, &amp;droppedPacket);</span>
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="keywordflow">if</span>(<a class="code" href="a00066.html#a9869bd7667eacdb3a9c5f8ecb0c3ed19" title="A queue to store packets from upper layer in case another packet is still waiting...">macQueue</a>.size() != 0) {
<a name="l00273"></a>00273       debugEV &lt;&lt; <span class="stringliteral">&quot; schedule backoff &quot;</span> &lt;&lt; endl;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="keywordtype">double</span> slots = intrand(<a class="code" href="a00066.html#a8ec2aea0983e2149d3c7d1c06637dd70" title="initial contention window size">initialCW</a> + <a class="code" href="a00066.html#a6c9b1b0f5eeb45db611633ca986f537b" title="count the number of tx attempts">txAttempts</a>) + 1.0 + dblrand();
<a name="l00276"></a>00276         <span class="keywordtype">double</span> time = slots * <a class="code" href="a00066.html#a420bec99b62f029c75996930bc5cb56f" title="Duration of a slot.">slotDuration</a>;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <a class="code" href="a00066.html#a6c9b1b0f5eeb45db611633ca986f537b" title="count the number of tx attempts">txAttempts</a>++;
<a name="l00279"></a>00279         debugEV &lt;&lt; <span class="stringliteral">&quot; attempts so far: &quot;</span> &lt;&lt; <a class="code" href="a00066.html#a6c9b1b0f5eeb45db611633ca986f537b" title="count the number of tx attempts">txAttempts</a>  &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; endl;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <a class="code" href="a00066.html#ae768a2dadff7e2e41a5ecae37bcedc2d" title="Counts the total number of backoffs.">nbBackoffs</a> = <a class="code" href="a00066.html#ae768a2dadff7e2e41a5ecae37bcedc2d" title="Counts the total number of backoffs.">nbBackoffs</a> + 1;
<a name="l00282"></a>00282     <a class="code" href="a00066.html#ace6a061501b4d12d2380a458ea253ef5" title="Counts the total time spent in backoff.">backoffValues</a> = <a class="code" href="a00066.html#ace6a061501b4d12d2380a458ea253ef5" title="Counts the total time spent in backoff.">backoffValues</a> + time;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         scheduleAt(simTime() + time, <a class="code" href="a00066.html#a946e29bb8fead33566797a7062649a1e" title="Timer for backoff (non-persistent CSMA).">backoffTimer</a>);
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 }
</pre></div></p>

</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="a5a0fde63ac12cccfdb98bfe6314ce46d"></a><!-- doxytag: member="CSMAMacLayer::difs" ref="a5a0fde63ac12cccfdb98bfe6314ce46d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="a00066.html#a5a0fde63ac12cccfdb98bfe6314ce46d">CSMAMacLayer::difs</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Maximum time between a packet and its ACK. </p>
<p>Usually this is slightly more then the tx-rx turnaround time The channel should stay clear within this period of time. </p>

<p>Definition at line <a class="el" href="a00334_source.html#l00115">115</a> of file <a class="el" href="a00334_source.html">CSMAMacLayer.h</a>.</p>

<p>Referenced by <a class="el" href="a00333_source.html#l00142">handleSelfMsg()</a>.</p>

</div>
</div>
<a class="anchor" id="ae3aa6dae3903cabacbcafe783ef33d91"></a><!-- doxytag: member="CSMAMacLayer::maxTxAttempts" ref="ae3aa6dae3903cabacbcafe783ef33d91" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned <a class="el" href="a00066.html#ae3aa6dae3903cabacbcafe783ef33d91">CSMAMacLayer::maxTxAttempts</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>maximum number of transmission attempts </p>
<p>The packet is discarded when this number is reached. </p>

<p>Definition at line <a class="el" href="a00334_source.html#l00146">146</a> of file <a class="el" href="a00334_source.html">CSMAMacLayer.h</a>.</p>

<p>Referenced by <a class="el" href="a00333_source.html#l00245">scheduleBackoff()</a>.</p>

</div>
</div>
<a class="anchor" id="af06855c96a26dbe77937062bead7f82c"></a><!-- doxytag: member="CSMAMacLayer::minorMsg" ref="af06855c96a26dbe77937062bead7f82c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cMessage* <a class="el" href="a00066.html#af06855c96a26dbe77937062bead7f82c">CSMAMacLayer::minorMsg</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Multi-purpose message. </p>
<p>Keeps track of things like minimum time of clear channel (important for atomic acks) and race condition avoidance. </p>

<p>Definition at line <a class="el" href="a00334_source.html#l00132">132</a> of file <a class="el" href="a00334_source.html">CSMAMacLayer.h</a>.</p>

<p>Referenced by <a class="el" href="a00333_source.html#l00142">handleSelfMsg()</a>, and <a class="el" href="a00333_source.html#l00245">scheduleBackoff()</a>.</p>

</div>
</div>
<a class="anchor" id="a420bec99b62f029c75996930bc5cb56f"></a><!-- doxytag: member="CSMAMacLayer::slotDuration" ref="a420bec99b62f029c75996930bc5cb56f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="a00066.html#a420bec99b62f029c75996930bc5cb56f">CSMAMacLayer::slotDuration</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Duration of a slot. </p>
<p>This duration can be a mini-slot (that is an RX-TX-turnaround time) but in general it should be the time it takes to send a packet plus some guard times (RX-TX-turnaround + a minimum inter-packet space). </p>

<p>Definition at line <a class="el" href="a00334_source.html#l00108">108</a> of file <a class="el" href="a00334_source.html">CSMAMacLayer.h</a>.</p>

<p>Referenced by <a class="el" href="a00333_source.html#l00289">encapsMsg()</a>, and <a class="el" href="a00333_source.html#l00245">scheduleBackoff()</a>.</p>

</div>
</div>
<a class="anchor" id="a6c9b1b0f5eeb45db611633ca986f537b"></a><!-- doxytag: member="CSMAMacLayer::txAttempts" ref="a6c9b1b0f5eeb45db611633ca986f537b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned <a class="el" href="a00066.html#a6c9b1b0f5eeb45db611633ca986f537b">CSMAMacLayer::txAttempts</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>count the number of tx attempts </p>
<p>This holds the number of transmission attempts, since no Acks are used this is the way how we can empty our queue even with overloaded channels. </p>

<p>Definition at line <a class="el" href="a00334_source.html#l00140">140</a> of file <a class="el" href="a00334_source.html">CSMAMacLayer.h</a>.</p>

<p>Referenced by <a class="el" href="a00333_source.html#l00222">handleLowerControl()</a>, and <a class="el" href="a00333_source.html#l00245">scheduleBackoff()</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>src/modules/mac/<a class="el" href="a00334_source.html">CSMAMacLayer.h</a></li>
<li>src/modules/mac/<a class="el" href="a00333_source.html">CSMAMacLayer.cc</a></li>
</ul>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed Dec 14 16:01:49 2011 for MiXiM by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
